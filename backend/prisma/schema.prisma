// schema.prisma

datasource db {
    provider = "postgresql"
    
    // url      = env("DATABASE_URL"),
}
generator erd {
  provider = "prisma-erd-generator"
}
generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["clientExtensions", "driverAdapters"]
}

//
// ------------------------------
// USERS
// ------------------------------
//

model User {
    id        String      @id @default(cuid())
    name      String
    email     String      @unique
    password  String
    stores    StoreUser[]
    createdAt DateTime    @default(now())
    updatedAt DateTime    @updatedAt
}

//
// ------------------------------
// STORES
// ------------------------------
//

model Store {
    id               String            @id @default(cuid())
    name             String
    slug             String            @unique
    phoneNumber      String?
    categories       Category[]
    products         Product[]
    orders           Order[]
    settings         StoreSettings?
    users            StoreUser[] // muitos admins
    createdAt        DateTime          @default(now())
    updatedAt        DateTime          @updatedAt
    complementGroups ComplementGroup[]
    images           Image[]
}

model StoreSettings {
    id              String  @id @default(cuid())
    storeId         String  @unique
    store           Store   @relation(fields: [storeId], references: [id])
    isOpen          Boolean @default(true)
    minOrderValue   Float?
    deliveryFee     Float?
    pickupEnabled   Boolean @default(true)
    deliveryEnabled Boolean @default(true)
    openHours       String?
}

model StoreUser {
    id      String    @id @default(cuid())
    storeId String
    userId  String
    role    StoreRole @default(ADMIN)
    store   Store     @relation(fields: [storeId], references: [id])
    user    User      @relation(fields: [userId], references: [id])

    @@unique([storeId, userId])
}

enum StoreRole {
    OWNER
    ADMIN
    STAFF
}

//
// ------------------------------
// PRODUCTS
// ------------------------------
//

model Category {
    id        String    @id @default(cuid())
    storeId   String
    store     Store     @relation(fields: [storeId], references: [id])
    name      String
    order     Int       @default(0)
    products  Product[]
    deletedAt DateTime?
}

model Product {
    id      String @id @default(cuid())
    storeId String
    store   Store  @relation(fields: [storeId], references: [id])

    categoryId              String?
    category                Category?                @relation(fields: [categoryId], references: [id])
    photoUrl                String?
    name                    String
    description             String?
    price                   Int
    image                   Json?
    isAvailable             Boolean                  @default(true)
    stock                   Int?
    createdAt               DateTime                 @default(now())
    deletedAt               DateTime?
    productComplementGroups ProductComplementGroup[]
}

//
// ------------------------------
// COMPLEMENTS (Adicionais)
// ------------------------------
//

model ComplementGroup {
    id          String                   @id @default(cuid())
    name        String
    minSelected Int                      @default(0)
    maxSelected Int?
    isAvailable Boolean                  @default(true)
    deletedAt   DateTime?
    storeId     String
    store       Store                    @relation(fields: [storeId], references: [id])
    complements Complement[]
    products    ProductComplementGroup[]
}

model Complement {
    id          String          @id @default(cuid())
    groupId     String
    group       ComplementGroup @relation(fields: [groupId], references: [id])
    name        String
    description String?
    price       Int             @default(0)
    isAvailable Boolean         @default(true)
    photoUrl    String?


}

model ProductComplementGroup {
    id        String @id @default(cuid())
    productId String
    groupId   String

    product Product         @relation(fields: [productId], references: [id])
    group   ComplementGroup @relation(fields: [groupId], references: [id])

    @@unique([productId, groupId])
}

model Image {
    id        String   @id @default(cuid())
    storeId   String
    url       String
    createdAt DateTime @default(now())

    store Store @relation(fields: [storeId], references: [id])
}

model Order {
    id      String @id @default(cuid())
    storeId String
    store   Store  @relation(fields: [storeId], references: [id])

    customerName  String?
    customerPhone String?

    status OrderStatus @default(PENDING)

    items OrderItem[]

    total Int // valor final fechado
    notes String?

    createdAt DateTime @default(now())
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  order     Order  @relation(fields: [orderId], references: [id])
  productId String?
  name     String
  quantity Int
  price    Int

  complements OrderItemComplement[]
}

model OrderItemComplement {
  id           String   @id @default(cuid())
  orderItemId  String
  orderItem    OrderItem @relation(fields: [orderItemId], references: [id])
  complementId String?
  name     String
  price    Int
  quantity Int
}
enum OrderStatus {
    PENDING
    CONFIRMED
    IN_PREPARATION
    IN_DELIVERY
    READY
    COMPLETED
    CANCELLED
}
